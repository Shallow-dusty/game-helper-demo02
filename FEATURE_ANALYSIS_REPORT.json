{
  "report_meta": {
    "generated_at": "2025-12-01",
    "repository": "game-helper-demo02",
    "total_commits_analyzed": 35,
    "description": "血染钟楼(Blood on the Clocktower)线上辅助工具功能分析报告"
  },

  "ai_chat": [
    {
      "commit": "89fc59f",
      "date": "2025-11-26",
      "description": "优化AI聊天功能，添加思考过程显示、清除/删除操作和可调整侧边栏",
      "details": "1. AI思考过程显示(thinking display)：用户可以看到AI的推理过程\n2. 添加消息清除和删除功能\n3. 侧边栏宽度可调整(resizable sidebar)\n4. 优化AI消息渲染"
    },
    {
      "commit": "cab195c",
      "date": "2025-11-28",
      "description": "AI配置优化 - 添加Gemini支持，显示API密钥状态",
      "details": "1. 新增Gemini 2.0 Flash模型支持(需科学上网)\n2. AI_CONFIG重构为类型化Record\n3. 显示API密钥配置状态(✓/✗)\n4. 分组显示AI提供商选项\n5. 导出getAiConfig()函数"
    },
    {
      "commit": "7373234",
      "date": "2025-11-29",
      "description": "移除Vite SiliconFlow API代理，改为直连",
      "details": "1. 移除vite.config.ts中的/api/sf代理配置\n2. 所有SiliconFlow模型改为直连API\n3. 更新baseURL为https://api.siliconflow.cn/v1"
    },
    {
      "commit": "98bd7b2",
      "date": "2025-11-28",
      "description": "Controls解耦与Chat虚拟滚动优化",
      "details": "1. Chat组件使用react-window实现虚拟滚动\n2. 超过50条消息自动启用虚拟滚动\n3. 使用useDynamicRowHeight支持动态行高\n4. 自动滚动到最新消息\n5. 保持iOS软键盘适配"
    }
  ],

  "audio": [
    {
      "commit": "97082f8",
      "date": "2025-11-28",
      "description": "音频管理器优化和开场公告",
      "details": "1. 优化音量调节逻辑防止应用卡顿\n2. 分离音量处理和播放逻辑\n3. 添加防抖机制减少云端同步频率\n4. 改善Promise处理避免AbortError"
    },
    {
      "commit": "651d503",
      "date": "2025-11-27",
      "description": "音频冲突修复",
      "details": "1. Lobby组件卸载时彻底清理音频资源\n2. AudioManager改善Promise处理\n3. 避免AbortError错误"
    },
    {
      "commit": "96d1e69",
      "date": "2025-11-28",
      "description": "AudioEnableOverlay音频激活引导",
      "details": "1. 新增AudioEnableOverlay组件\n2. 引导用户点击激活音频播放权限\n3. 解决浏览器自动播放限制问题"
    }
  ],

  "game_logic": [
    {
      "commit": "446be87",
      "date": "2025-12-01",
      "description": "完成测试覆盖率扩展 - 投票处决逻辑和游戏结束判定",
      "details": "1. 实现投票处决逻辑(票数过半判定)\n2. 实现checkGameOver函数(含圣徒被处决判定)\n3. 修复日志隐私泄露bug(isPrivate检查顺序)\n4. 31个测试全部通过"
    },
    {
      "commit": "b59eb22",
      "date": "2025-12-01",
      "description": "实现投票处决逻辑和日志隐私过滤",
      "details": "1. createGameSlice添加closeVote投票结算逻辑\n2. 票数>=存活人数一半时执行处决\n3. 处决后检查游戏结束(圣徒/恶魔死亡)\n4. utils.ts添加私密消息过滤"
    },
    {
      "commit": "790cefc",
      "date": "2025-11-28",
      "description": "创建游戏核心逻辑层lib/gameLogic.ts",
      "details": "1. 抽取buildNightQueue夜间行动顺序生成\n2. 抽取handlePhaseChange阶段切换处理\n3. 抽取createVotingState投票状态创建\n4. sandboxStore使用共享逻辑消除代码重复"
    },
    {
      "commit": "32a838a",
      "date": "2025-11-26",
      "description": "P0/P1/P2功能实现 - 夜间行动反馈循环",
      "details": "1. claim_seat/leave_seat RPC集成防止并发抢座\n2. 游戏开始后禁止修改角色分配\n3. 夜间行动反馈循环：玩家提交→ST通知→ST回复→玩家结果\n4. NightActionManager组件管理待处理夜间行动"
    },
    {
      "commit": "2d2820c",
      "date": "2025-11-26",
      "description": "投票防抖、身份锁定、数据库迁移脚本",
      "details": "1. 投票按钮添加防抖机制\n2. 身份锁定防止重复投票\n3. 添加supabase_migration.sql数据库迁移脚本"
    },
    {
      "commit": "0fcea32",
      "date": "2025-11-28",
      "description": "优化板子分配策略配置",
      "details": "1. 更新4种策略：平衡/邪恶优势/好人优势/混乱模式\n2. 新增ROLE_STRENGTH角色强度分类\n3. 优化generateRoles算法按强度分级选择\n4. 策略详情展示具体角色强度建议"
    },
    {
      "commit": "a5683d1",
      "date": "2025-11-29",
      "description": "实现自定义剧本编辑器",
      "details": "1. 新增ScriptEditor组件\n2. 支持创建自定义剧本\n3. 角色选择和筛选功能\n4. 保存到customScripts"
    },
    {
      "commit": "4eebbe2",
      "date": "2025-11-26",
      "description": "自定义剧本加载器JSON支持",
      "details": "1. 添加ScriptDefinition接口\n2. 实现importScript解析验证JSON\n3. 添加文件上传UI和导入按钮\n4. 剧本选择器动态显示导入的自定义剧本"
    }
  ],

  "ui": [
    {
      "commit": "1787c47",
      "date": "2025-11-30",
      "description": "UI设计优化 - 玻璃拟态和动画效果",
      "details": "1. 采用玻璃拟态(Glassmorphism)设计风格\n2. 添加backdrop-blur毛玻璃效果\n3. Tab切换添加发光动画(pulse-glow)\n4. 按钮hover添加scale动画效果"
    },
    {
      "commit": "3f27cd1",
      "date": "2025-11-30",
      "description": "完整UI优化",
      "details": "1. 新增button/card/dialog/context-menu UI组件\n2. BackgroundEffects背景效果组件\n3. StorytellerMenu说书人菜单\n4. 添加lucide-react图标库\n5. 优化Grimoire和Controls布局"
    },
    {
      "commit": "c9e73b9",
      "date": "2025-11-30",
      "description": "UI本地化为中文",
      "details": "1. 所有界面文本翻译为中文\n2. Tab标签：游戏/聊天/AI助手/音效/笔记\n3. 按钮文本中文化\n4. BackgroundEffects视觉优化"
    },
    {
      "commit": "73d03cb",
      "date": "2025-11-30",
      "description": "高&中优先级UX优化(v0.8.1)",
      "details": "1. 房间号输入满4位自动提交\n2. 中途加入游戏显示警告提示\n3. 强制天亮按钮二次确认\n4. 说书人模式视觉增强(发光/缩放/图标)\n5. 离线模式按钮Tooltip提示"
    },
    {
      "commit": "d46288d",
      "date": "2025-11-30",
      "description": "Toast通知系统和游戏大师控制优化",
      "details": "1. 座位管理/角色管理/游戏流程分区可折叠\n2. 按钮布局优化为3列网格\n3. Grimoire状态图标环形布局\n4. 字体大小防止过小(Math.max)"
    },
    {
      "commit": "4b26fa2",
      "date": "2025-11-30",
      "description": "核心游戏UI组件",
      "details": "1. 修复角色分配逻辑包含所有座位\n2. 修复板子配置建议随机化问题\n3. 添加PROJECT_REVIEW_REPORT安全审查报告"
    },
    {
      "commit": "651d503",
      "date": "2025-11-27",
      "description": "移动端魔典双指缩放",
      "details": "1. Grimoire支持双指缩放(pinch-zoom)\n2. 鼠标滚轮缩放(桌面端)\n3. 缩放百分比指示器\n4. 重置缩放按钮\n5. 平移手势支持"
    },
    {
      "commit": "0c12e89",
      "date": "2025-11-28",
      "description": "Grimoire游戏面板UI",
      "details": "1. 交互式玩家座位Canvas渲染\n2. 座位状态显示(死亡/投票/夜间行动)\n3. 长按座位打开上下文菜单\n4. 说书人/玩家视图差异化显示"
    },
    {
      "commit": "790cefc",
      "date": "2025-11-28",
      "description": "UI修复与Z_INDEX层级管理",
      "details": "1. 统一Z_INDEX常量区分sidebar/modal/floatingPanel层级\n2. 移动端悬浮投票按钮FloatingVoteButton\n3. 角色说明书增强搜索和阵营折叠\n4. VoteButton支持幽灵票状态"
    }
  ],

  "storyteller": [
    {
      "commit": "d46288d",
      "date": "2025-11-30",
      "description": "说书人控制面板优化",
      "details": "1. 座位管理区块(添加虚拟玩家/座位)\n2. 角色管理区块(自动分配/发放角色)\n3. 游戏流程区块(进入夜晚/天亮)\n4. 振动提醒开关"
    },
    {
      "commit": "cbdf1e6",
      "date": "2025-11-29",
      "description": "游戏历史视图集成",
      "details": "1. ControlsSTSection添加历史记录按钮\n2. 说书人可查看游戏历史\n3. 集成HistoryViewer组件"
    },
    {
      "commit": "98bd7b2",
      "date": "2025-11-28",
      "description": "Controls组件解耦",
      "details": "1. 拆分ControlsSTSection.tsx(说书人控制区~347行)\n2. 拆分ControlsPlayerSection.tsx(玩家控制区~358行)\n3. 主文件减少约60%(1088→447行)\n4. 移动ActiveAbilityButton到玩家组件"
    },
    {
      "commit": "f365422",
      "date": "2025-11-29",
      "description": "说书人笔记本增强",
      "details": "1. 新增FloatingNote悬浮笔记组件\n2. 支持拖拽移动笔记位置\n3. 笔记颜色更改功能\n4. 笔记折叠/展开功能"
    },
    {
      "commit": "32a838a",
      "date": "2025-11-26",
      "description": "夜间行动管理器",
      "details": "1. NightActionManager组件\n2. 说书人端管理待处理夜间行动\n3. 支持快捷回复玩家\n4. 夜间行动请求列表"
    }
  ],

  "player": [
    {
      "commit": "d279cf3",
      "date": "2025-11-30",
      "description": "角色揭示模态框组件",
      "details": "1. RoleRevealModal角色揭示弹窗\n2. 3D卡片翻转动画效果\n3. 点击翻开命运之书交互\n4. 角色信息展示(名称/阵营/技能)\n5. 确认后飞向左下角动画"
    },
    {
      "commit": "4004747",
      "date": "2025-11-30",
      "description": "增强设置体验",
      "details": "1. WaitingArea添加最小化功能\n2. RoleRevealModal添加倒计时(3-2-1-GAME START)\n3. 清理console.log和测试文件"
    },
    {
      "commit": "71f4247",
      "date": "2025-11-30",
      "description": "玩家角色显示与主动技能控制",
      "details": "1. CompactRoleDisplay紧凑角色显示组件\n2. 角色信息折叠/展开功能\n3. ActiveAbilityButton主动技能按钮集成\n4. 夜间阶段UI优化"
    },
    {
      "commit": "41bec95",
      "date": "2025-11-27",
      "description": "多项UX与稳定性改进",
      "details": "1. 投票按钮状态优化\n2. 夜间行动界面改进\n3. 聊天iOS软键盘适配\n4. 离席功能优化"
    },
    {
      "commit": "e91769f",
      "date": "2025-11-27",
      "description": "version 2更多功能",
      "details": "1. NightActionPanel夜间行动面板\n2. RoleCard角色卡片组件\n3. VotingChart投票图表\n4. PhaseIndicator阶段指示器\n5. RoleReferencePanel/Sidebar角色参考面板"
    },
    {
      "commit": "96d1e69",
      "date": "2025-11-28",
      "description": "主动技能按钮和投票按钮组件",
      "details": "1. ActiveAbilityButton.tsx独立组件\n2. VoteButton.tsx独立组件\n3. 支持不同角色的主动技能触发"
    }
  ],

  "room_lobby": [
    {
      "commit": "c96c065",
      "date": "2025-11-30",
      "description": "房间选择、大厅和说书人菜单组件",
      "details": "1. RoomSelection房间选择界面优化\n2. Lobby大厅界面中文化\n3. StorytellerMenu说书人菜单\n4. 支持创建、加入和沙盒模式"
    },
    {
      "commit": "8412803",
      "date": "2025-11-30",
      "description": "WaitingArea和Controls组件优化",
      "details": "1. WaitingArea等待区域组件\n2. 角色分配逻辑更新包含所有座位\n3. 添加3D卡片翻转CSS工具类"
    },
    {
      "commit": "96d1e69",
      "date": "2025-11-28",
      "description": "沙盒模式实现",
      "details": "1. SandboxView.tsx沙盒视图组件\n2. sandboxStore.ts独立状态管理\n3. 离线练习无需Supabase\n4. VoiceRoomLink外部语音房间链接"
    },
    {
      "commit": "73d03cb",
      "date": "2025-11-30",
      "description": "房间号自动提交和中途加入提示",
      "details": "1. 房间号输入满4位自动提交\n2. 中途加入游戏显示警告提示\n3. 说书人模式视觉增强"
    },
    {
      "commit": "97082f8",
      "date": "2025-11-28",
      "description": "开场公告功能",
      "details": "1. WelcomeAnnouncement组件\n2. 说明魔典基本信息和主要功能\n3. 支持不再显示选项\n4. 标注语音室功能开发计划"
    }
  ],

  "architecture": [
    {
      "commit": "69888be",
      "date": "2025-11-30",
      "description": "将单体Store拆分为Slices并移至src目录",
      "details": "1. 创建src目录结构\n2. 拆分store.ts为createAISlice/createConnectionSlice/createGameSlice/createUISlice\n3. 添加store/types.ts类型定义\n4. 添加store/utils.ts工具函数\n5. 删除2478行单体store.ts"
    },
    {
      "commit": "96d1e69",
      "date": "2025-11-28",
      "description": "架构优化与基础设施升级",
      "details": "1. ESLint 9 + TypeScript严格模式\n2. Vitest测试框架(25个单元测试)\n3. Husky + lint-staged预提交检查\n4. immer中间件集成到Zustand\n5. useLongPress自定义Hook"
    },
    {
      "commit": "2e8dc27",
      "date": "2025-11-29",
      "description": "全面代码审查修复",
      "details": "1. 修复TypeScript类型错误\n2. 清理重复代码\n3. 改善错误处理"
    },
    {
      "commit": "790cefc",
      "date": "2025-11-28",
      "description": "架构重构创建游戏核心逻辑层",
      "details": "1. lib/gameLogic.ts游戏核心逻辑(288行)\n2. 抽取共享函数消除代码重复\n3. 统一Z_INDEX层级管理"
    },
    {
      "commit": "98bd7b2",
      "date": "2025-11-28",
      "description": "Controls组件解耦重构",
      "details": "1. 拆分为ControlsSTSection和ControlsPlayerSection\n2. 主文件减少约60%\n3. 提高代码可维护性"
    }
  ],

  "summary": {
    "total_features": 35,
    "by_category": {
      "ai_chat": 4,
      "audio": 3,
      "game_logic": 8,
      "ui": 10,
      "storyteller": 5,
      "player": 6,
      "room_lobby": 5,
      "architecture": 5
    },
    "key_highlights": [
      "完整的AI助手集成(DeepSeek/Gemini/Kimi等多模型支持)",
      "玻璃拟态UI设计风格和丰富动画效果",
      "完整的血染钟楼游戏流程支持(夜间行动/投票处决/角色揭示)",
      "Store架构从单体拆分为Slices提升可维护性",
      "沙盒模式支持离线练习",
      "移动端双指缩放和触控优化"
    ]
  }
}
