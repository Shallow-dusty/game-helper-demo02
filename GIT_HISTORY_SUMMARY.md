# 📜 Git 提交历史汇总文档

> 项目名称: Blood on the Clocktower Helper (血染钟楼助手)\
> 统计周期: 2025-11-26 至 2025-12-01\
> 总提交数: 99 次\
> 贡献者: Shallow (49次), HongYu Zhang (38次), Shallow-dusty (12次)

---

## 目录

1. [Bug 修复汇总](#bug-修复汇总)
   - [AI/聊天模块](#1-ai聊天模块-bug)
   - [音频模块](#2-音频模块-bug)
   - [游戏核心逻辑](#3-游戏核心逻辑-bug)
   - [UI/界面模块](#4-ui界面模块-bug)
   - [移动端适配](#5-移动端适配-bug)
   - [网络/连接模块](#6-网络连接模块-bug)
   - [类型/代码质量](#7-类型代码质量-bug)
2. [新功能汇总](#新功能汇总)
   - [AI/聊天模块](#1-ai聊天模块-功能)
   - [音频模块](#2-音频模块-功能)
   - [游戏核心逻辑](#3-游戏核心逻辑-功能)
   - [UI/界面模块](#4-ui界面模块-功能)
   - [说书人功能](#5-说书人功能)
   - [玩家功能](#6-玩家功能)
   - [房间/大厅](#7-房间大厅-功能)
   - [架构/重构](#8-架构重构)

---

# Bug 修复汇总

## 1. AI/聊天模块 Bug

| 提交      | 日期       | 问题描述      | 修复详情                                                                                                          |
| --------- | ---------- | ------------- | ----------------------------------------------------------------------------------------------------------------- |
| `538eb96` | 2025-12-01 | 日志隐私泄露  | 私聊消息未正确过滤，导致其他玩家可见。现在 `filterLogsForPlayer` 正确过滤私聊消息，仅对发送者、接收者和说书人可见 |
| `cab195c` | 2025-11-28 | AI 配置不完整 | 添加 API 密钥状态显示，用户可以清楚看到哪些 AI 服务已配置                                                         |

## 2. 音频模块 Bug

| 提交      | 日期       | 问题描述              | 修复详情                                                                       |
| --------- | ---------- | --------------------- | ------------------------------------------------------------------------------ |
| `4b904c8` | 2025-11-28 | AudioManager 内存泄漏 | `setTimeout` 未清理导致内存泄漏，添加 `cleanupTimeoutRef` 正确跟踪和清理定时器 |
| `c87f440` | 2025-11-28 | 音乐播放异常          | 修复音乐播放逻辑错误                                                           |
| `67a55e1` | 2025-11-27 | 音频重复播放          | 修复历史归档时音频重复播放的问题                                               |
| `a3f78ed` | 2025-11-27 | 音频错误处理不当      | 改进音频错误处理机制，添加更好的降级策略                                       |
| `2768c67` | 2025-11-27 | 音效播放问题          | 修复音效无法正常播放的问题                                                     |
| `55b6222` | 2025-11-30 | Audio UX 问题         | 解决音频用户体验相关的多个问题                                                 |
| `06d4df8` | 2025-11-30 | AudioManager 类型错误 | 修复 TypeScript 类型错误导致的编译失败                                         |
| `b2dd08a` | 2025-11-27 | 下载器稳定性          | 稳定夜间行动和音频下载器                                                       |

## 3. 游戏核心逻辑 Bug

| 提交      | 日期       | 问题描述             | 修复详情                                                                         |
| --------- | ---------- | -------------------- | -------------------------------------------------------------------------------- |
| `538eb96` | 2025-12-01 | 投票处决逻辑缺失     | `closeVote` 未执行处决逻辑。现在正确执行处决、检查圣徒特殊规则、更新游戏结束条件 |
| `0dc66dd` | 2025-12-01 | 自动分配策略 bug     | 修复角色自动分配算法的多个漏洞，增强安全性检查                                   |
| `2bcee68` | 2025-11-30 | 角色揭示自动触发逻辑 | 修复角色揭示模态框的自动触发逻辑错误                                             |
| `7d0cad5` | 2025-11-30 | 角色揭示动画         | 修复角色揭示动画不正常播放的问题，添加手动触发按钮作为备选                       |
| `69aa7df` | 2025-11-30 | 强制离席功能         | 补充 `Grimoire.tsx` 中缺失的 `forceLeaveSeat` 属性传递                           |
| `97082f8` | 2025-11-28 | 虚拟玩家漏洞         | 修复虚拟玩家功能中的多个逻辑漏洞                                                 |
| `b2dd08a` | 2025-11-27 | 夜间行动不稳定       | 稳定夜间行动反馈循环机制                                                         |
| `67a55e1` | 2025-11-27 | 历史归档投票         | 修复历史归档时投票数据丢失的问题                                                 |
| `885346d` | 2025-11-29 | store.ts 逻辑错误    | 修复 store.ts 中的逻辑错误，移除重复代码                                         |
| `70b5dbe` | 2025-11-27 | 游戏逻辑 bug         | 修复游戏核心逻辑中的错误                                                         |
| `pending` | 2025-12-02 | 夜间行动队列错误     | 修复 `flow.ts` 中夜间行动队列计算逻辑，解决计数器 0/0 问题                       |

## 4. UI/界面模块 Bug

| 提交      | 日期       | 问题描述                    | 修复详情                                                                            |
| --------- | ---------- | --------------------------- | ----------------------------------------------------------------------------------- |
| `4b904c8` | 2025-11-28 | FloatingVoteButton 属性错误 | 修复 `odId→id` 拼写错误和 `isActive→isOpen` 属性错误                                |
| `4b904c8` | 2025-11-28 | Z-Index 层级混乱            | RoleReferenceSidebar 从 20 调整为 40，Grimoire 上下文菜单使用统一的 `Z_INDEX.modal` |
| `e611c36` | 2025-11-30 | StorytellerMenu 重复定义    | 移除组件中的重复变量定义                                                            |
| `61ea311` | 2025-11-28 | ESC 键关闭功能              | 修复 ESC 键无法正常关闭模态框的问题                                                 |
| `160b8c6` | 2025-11-29 | 移动端 ST 控制台 z-index    | 修复移动端说书人控制台的层级遮挡问题                                                |
| `55b6222` | 2025-11-30 | WaitingArea 锁定问题        | 解决等待区域的锁定状态问题                                                          |
| `55b6222` | 2025-11-30 | VoiceRoomLink 问题          | 修复语音房间链接相关问题                                                            |
| `c1a1465` | 2025-11-27 | 语法错误                    | 修复组件中的语法错误                                                                |
| `d234f6e` | 2025-11-27 | VotingChart 类型错误        | 修复投票图表组件的 TypeScript 类型错误                                              |
| `d63302a` | 2025-11-30 | UI 优化问题                 | 解决 Supabase Edge Function lint 错误并优化 UI                                      |
| `pending` | 2025-12-02 | 重复音频控制                | 移除 `ControlsSTSection.tsx` 中冗余的音频控制 UI                                    |
| `pending` | 2025-12-02 | 未使用的变量                | 清理 `ControlsSTSection.tsx` 和 `Grimoire.tsx` 中的未使用的变量和导入               |

## 5. 移动端适配 Bug

| 提交      | 日期       | 问题描述           | 修复详情                                                                       |
| --------- | ---------- | ------------------ | ------------------------------------------------------------------------------ |
| `8f792be` | 2025-11-27 | 移动端滚动问题     | 彻底重构移动端布局，使用 `-webkit-overflow-scrolling: touch` 支持 iOS 弹性滚动 |
| `af9b8b1` | 2025-11-27 | 无法滚动到加入房间 | 修复移动端无法滚动看到"加入房间"按钮的问题                                     |
| `f9be8c9` | 2025-11-27 | 视口尺寸问题       | 改进移动端视口尺寸计算                                                         |
| `f818bd7` | 2025-11-27 | Canvas 缩放问题    | 修复移动端 canvas 尺寸计算，添加安全检查                                       |
| `074f0f7` | 2025-11-27 | 布局滚动问题       | 重构移动端布局使用 flexbox，防止意外滚动                                       |
| `a3f78ed` | 2025-11-27 | UI 缩放问题        | 修复移动端 UI 缩放比例问题                                                     |
| `607e4dc` | 2025-11-27 | 移动端 UI 优化     | 全面优化移动端 UI 表现                                                         |
| `2768c67` | 2025-11-27 | 移动端 UI 问题     | 修复移动端 UI 显示问题                                                         |
| `688a79f` | 2025-11-26 | 手机屏幕适配       | 修复手机屏幕显示问题                                                           |

## 6. 网络/连接模块 Bug

| 提交      | 日期       | 问题描述                    | 修复详情                                       |
| --------- | ---------- | --------------------------- | ---------------------------------------------- |
| `9b84589` | 2025-11-27 | 重连失败体验差              | 改善断线重连失败后的用户体验，添加更友好的提示 |
| `d63302a` | 2025-11-30 | Supabase Edge Function 错误 | 解决 Supabase Edge Function 的 lint 错误       |
| `0dc66dd` | 2025-12-01 | 安全性问题                  | 增强连接模块的安全性检查                       |

## 7. 类型/代码质量 Bug

| 提交      | 日期       | 问题描述                     | 修复详情                                                                           |
| --------- | ---------- | ---------------------------- | ---------------------------------------------------------------------------------- |
| `f77a2f2` | 2025-11-28 | React hooks 顺序错误导致崩溃 | 多个组件因早期返回导致 hooks 调用顺序不一致，统一将条件返回移到所有 hooks 调用之后 |
| `44f70e5` | 2025-11-27 | React hooks 顺序错误导致黑屏 | 类似问题，修复导致页面黑屏的 hooks 顺序问题                                        |
| `e72ef26` | 2025-11-28 | ESLint 配置与类型修复        | 优化 ESLint 配置，修复多个 TypeScript 类型错误                                     |
| `ee2c040` | 2025-12-01 | 测试 lint 错误               | 解决测试文件中的 lint 错误，扩展测试覆盖率                                         |
| `834d7b0` | 2025-12-01 | 严格类型检查                 | 强制执行严格类型检查，修复相关 lint 错误                                           |

---

# 新功能汇总

## 1. AI/聊天模块 功能

| 提交      | 日期       | 功能描述      | 实现详情                                                    |
| --------- | ---------- | ------------- | ----------------------------------------------------------- |
| `89fc59f` | 2025-11-26 | AI 聊天优化   | 添加 AI 思考过程显示、清除/删除消息操作、可调整大小的侧边栏 |
| `cab195c` | 2025-11-28 | AI 配置优化   | 添加 Gemini 2.0 Flash 支持，显示 API 密钥配置状态           |
| `7373234` | 2025-11-29 | API 直连      | 移除 Vite SiliconFlow API 代理，改为直连模式，更新模型配置  |
| `98bd7b2` | 2025-11-28 | Chat 虚拟滚动 | 实现聊天消息的虚拟滚动，提升大量消息时的性能                |

**支持的 AI 模型:**

- DeepSeek V3
- Gemini 2.0 Flash
- Kimi (月之暗面)
- SiliconFlow

## 2. 音频模块 功能

| 提交      | 日期       | 功能描述     | 实现详情                                         |
| --------- | ---------- | ------------ | ------------------------------------------------ |
| `96d1e69` | 2025-11-28 | 音频激活引导 | 新增 `AudioEnableOverlay` 组件，引导用户激活音频 |
| `a3f78ed` | 2025-11-27 | 音频脚本     | 添加音频素材抓取脚本 (scrape_audio.py)           |
| `d46288d` | 2025-11-30 | 音频管理     | 集成音频管理到游戏大师控制系统                   |

## 3. 游戏核心逻辑 功能

| 提交      | 日期       | 功能描述       | 实现详情                                         |
| --------- | ---------- | -------------- | ------------------------------------------------ |
| `4eebbe2` | 2025-11-26 | 自定义剧本加载 | 支持通过 JSON 文件加载自定义剧本                 |
| `a5683d1` | 2025-11-29 | 剧本编辑器     | 实现完整的自定义剧本编辑器                       |
| `2d2820c` | 2025-11-26 | 投票防抖       | 添加投票防抖机制，防止重复点击；实现身份锁定功能 |
| `41bec95` | 2025-11-27 | 夜间行动改进   | 改进夜间行动的反馈循环和稳定性                   |
| `538eb96` | 2025-12-01 | 投票处决逻辑   | 完整实现投票处决逻辑，包括圣徒特殊规则           |
| `b59eb22` | 2025-12-01 | 日志隐私过滤   | 实现游戏日志的隐私过滤机制                       |
| `0fcea32` | 2025-11-28 | 分配策略配置   | 优化角色分配策略配置选项                         |
| `8412803` | 2025-11-30 | 角色分配更新   | 更新角色分配逻辑以包含所有座位                   |

## 4. UI/界面模块 功能

| 提交      | 日期       | 功能描述          | 实现详情                                        |
| --------- | ---------- | ----------------- | ----------------------------------------------- |
| `1787c47` | 2025-11-30 | 玻璃拟态设计      | 采用 Glassmorphism 设计风格，添加丰富的动画效果 |
| `c9e73b9` | 2025-11-30 | 中文本地化        | 完成 UI 中文本地化，优化视觉效果                |
| `3f27cd1` | 2025-11-30 | UI 全面优化       | 完成 UI 整体优化                                |
| `0c12e89` | 2025-11-28 | Grimoire 游戏面板 | 添加交互式玩家座位和状态显示的 Grimoire 面板    |
| `f365422` | 2025-11-29 | 新 UI 组件        | 添加游戏控制、浮动笔记、角色卡片等组件          |
| `4b26fa2` | 2025-11-30 | 核心 UI 组件      | 添加控制面板、大厅、房间选择、背景效果组件      |
| `d46288d` | 2025-11-30 | Toast 通知系统    | 实现全局 Toast 通知系统                         |
| `73d03cb` | 2025-11-30 | UX 优化 (v0.8.1)  | 实现高优先级和中优先级的 UX 优化项目            |
| `790cefc` | 2025-11-28 | UI 修复与重构     | v0.8.0 版本的 UI 修复和架构重构                 |
| `8412803` | 2025-11-30 | 3D 卡片翻转       | 添加 3D 卡片翻转 CSS 效果工具                   |
| `pending` | 2025-12-02 | 卷轴开关          | 将编辑模式开关替换为沉浸式卷轴组件              |
| `pending` | 2025-12-02 | 羊皮纸风格        | 优化说明书和笔记本的 UI 为羊皮纸风格            |

**UI 组件清单:**

- `BackgroundEffects.tsx` - 背景动画效果
- `Confetti.tsx` - 彩带/庆祝效果
- `Toast.tsx` - 通知组件
- `InfoCard.tsx` - 信息卡片
- `button.tsx` / `card.tsx` / `dialog.tsx` - 基础 UI 组件

## 5. 说书人功能

| 提交      | 日期       | 功能描述      | 实现详情                               |
| --------- | ---------- | ------------- | -------------------------------------- |
| `cbdf1e6` | 2025-11-29 | 游戏历史视图  | 为说书人集成游戏历史查看功能           |
| `c96c065` | 2025-11-30 | 说书人菜单    | 添加说书人菜单组件，支持游戏控制       |
| `d46288d` | 2025-11-30 | 游戏大师控制  | 添加剧本管理和夜间行动管理             |
| `98bd7b2` | 2025-11-28 | Controls 解耦 | 将 Controls 组件拆分解耦，提升可维护性 |
| `73d03cb` | 2025-11-30 | 说书人笔记本  | 改进说书人笔记本功能                   |

**说书人工具组件:**

- `StorytellerMenu.tsx` - 说书人主菜单
- `StorytellerNotebook.tsx` - 说书人笔记本
- `ControlsSTSection.tsx` - 说书人控制区
- `NightActionManager.tsx` - 夜间行动管理
- `NightActionPanel.tsx` - 夜间行动面板
- `GameHistoryView.tsx` - 游戏历史视图
- `ScriptManager.tsx` - 剧本管理
- `ScriptEditor.tsx` - 剧本编辑器

## 6. 玩家功能

| 提交      | 日期       | 功能描述       | 实现详情                                      |
| --------- | ---------- | -------------- | --------------------------------------------- |
| `d279cf3` | 2025-11-30 | 角色揭示模态框 | 添加 RoleRevealModal 组件，带有精美的揭示动画 |
| `71f4247` | 2025-11-30 | 玩家角色显示   | 添加玩家角色显示与主动技能控制                |
| `96d1e69` | 2025-11-28 | 主动技能按钮   | 新增 `ActiveAbilityButton.tsx` 组件           |
| `96d1e69` | 2025-11-28 | 投票按钮       | 新增 `VoteButton.tsx` 组件                    |
| `41bec95` | 2025-11-27 | 离席功能       | 改进玩家离席和键盘适配功能                    |
| `2d2820c` | 2025-11-26 | 身份锁定       | 实现玩家身份锁定功能                          |

**玩家相关组件:**

- `PlayerNightAction.tsx` - 玩家夜间行动
- `PlayerNotebook.tsx` - 玩家笔记本
- `RoleCard.tsx` - 角色卡片
- `RoleRevealModal.tsx` - 角色揭示动画
- `FloatingVoteButton.tsx` - 浮动投票按钮

## 7. 房间/大厅 功能

| 提交      | 日期       | 功能描述     | 实现详情                                        |
| --------- | ---------- | ------------ | ----------------------------------------------- |
| `96d1e69` | 2025-11-28 | 沙盒模式     | 支持离线练习，无需 Supabase 连接                |
| `c96c065` | 2025-11-30 | 房间选择     | 添加房间选择组件，支持创建、加入房间            |
| `96d1e69` | 2025-11-28 | 语音房间链接 | 新增 `VoiceRoomLink.tsx` 组件，支持外部语音房间 |
| `97082f8` | 2025-11-28 | 开场公告     | 添加 `WelcomeAnnouncement.tsx` 开场公告组件     |
| `8412803` | 2025-11-30 | 等待区域     | 新增 `WaitingArea.tsx` 组件                     |

**房间相关组件:**

- `RoomSelection.tsx` - 房间选择
- `Lobby.tsx` - 大厅
- `WaitingArea.tsx` - 等待区域
- `SandboxView.tsx` - 沙盒模式视图
- `VoiceRoomLink.tsx` - 语音房间链接

## 8. 架构/重构

| 提交      | 日期       | 功能描述       | 实现详情                                     |
| --------- | ---------- | -------------- | -------------------------------------------- |
| `69888be` | 2025-11-30 | Store 拆分     | 将 2478 行的单体 store.ts 拆分为多个 Slices  |
| `96d1e69` | 2025-11-28 | 测试框架       | 集成 Vitest 测试框架，添加 25 个单元测试     |
| `446be87` | 2025-12-01 | 测试覆盖率扩展 | 扩展测试覆盖率至 31 个测试通过               |
| `2e8dc27` | 2025-11-29 | 代码审查修复   | 全面代码审查并修复问题                       |
| `96d1e69` | 2025-11-28 | 组件拆分       | 将大组件拆分为小组件，添加 useLongPress hook |

**Store 架构 (拆分后):**

```
src/store/
├── store.ts              # 主 Store 入口
├── aiConfig.ts           # AI 配置
├── types.ts              # 类型定义
├── utils.ts              # 工具函数
└── slices/
    ├── createAISlice.ts          # AI 状态切片
    ├── createConnectionSlice.ts  # 连接状态切片
    ├── createGameSlice.ts        # 游戏状态切片
    └── createUISlice.ts          # UI 状态切片
```

**测试文件:**

```
tests/
├── setup.ts                          # 测试环境配置
├── integration/
│   └── gameFlow.test.ts              # 集成测试
src/
├── hooks/useLongPress.test.ts        # Hook 测试
├── lib/gameLogic.test.ts             # 游戏逻辑测试
└── store/
    ├── utils.test.ts                 # 工具函数测试
    └── slices/
        ├── createAISlice.test.ts     # AI 切片测试
        ├── createConnectionSlice.test.ts
        └── createGameSlice.test.ts
```

---

## 版本里程碑

| 版本       | 日期       | 主要内容                                   |
| ---------- | ---------- | ------------------------------------------ |
| v0.7.1     | 2025-11-26 | UI 优化和 Bug 修复                         |
| v0.7.4     | 2025-11-27 | 全面代码审查，修复 VotingChart 类型错误    |
| v0.7.5     | 2025-11-28 | 架构优化与沙盒模式，ESLint 9 + Vitest      |
| v0.8.0     | 2025-11-28 | 多项崩溃修复、Controls 解耦、Chat 虚拟滚动 |
| v0.8.1     | 2025-11-30 | 高/中优先级 UX 优化                        |
| v4.0 (tag) | 2025-11-28 | ESLint 配置优化与类型修复                  |

---

## 统计摘要

### Bug 修复统计

| 模块          | 修复数量 |
| ------------- | -------- |
| AI/聊天模块   | 2        |
| 音频模块      | 8        |
| 游戏核心逻辑  | 10       |
| UI/界面模块   | 10       |
| 移动端适配    | 9        |
| 网络/连接模块 | 3        |
| 类型/代码质量 | 5        |
| **总计**      | **47**   |

### 新功能统计

| 模块         | 功能数量 |
| ------------ | -------- |
| AI/聊天模块  | 4        |
| 音频模块     | 3        |
| 游戏核心逻辑 | 8        |
| UI/界面模块  | 10       |
| 说书人功能   | 5        |
| 玩家功能     | 6        |
| 房间/大厅    | 5        |
| 架构/重构    | 5        |
| **总计**     | **46**   |

---

## 关键亮点

### 🔴 最重要的 Bug 修复

1. **日志隐私泄露** - 私聊消息现在正确过滤
2. **React hooks 崩溃** - 多处 hooks 顺序问题导致应用崩溃
3. **移动端滚动** - iOS 弹性滚动完全重构
4. **AudioManager 内存泄漏** - setTimeout 正确清理

### 🌟 最重要的新功能

1. **沙盒模式** - 离线练习无需后端连接
2. **多 AI 模型支持** - DeepSeek/Gemini/Kimi/SiliconFlow
3. **玻璃拟态 UI** - 现代化视觉设计
4. **Store 架构拆分** - 从 2478 行拆分为模块化切片
5. **角色揭示动画** - 精美的卡片翻转效果
6. **完整测试覆盖** - 31 个测试通过

---

_文档生成时间: 2025-12-01_\
_本文档由 GitHub Copilot 自动生成_
