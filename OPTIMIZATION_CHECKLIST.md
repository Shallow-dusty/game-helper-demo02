# 🔧 Grimoire Web 优化清单

> **审查日期**: 2025-11-27  
> **审查版本**: v0.7.1  
> **审查范围**: 26个源文件 + 4个文档文件  
> **最后更新**: 2025-11-27 (修复完成)

---

## 📊 审查摘要

| 类别 | 数量 | 状态 |
|------|------|------|
| 🔴 严重问题 (Critical) | 3 | ✅ 已修复 |
| 🟠 中等问题 (Medium) | 4 | ✅ 3/4 已修复 |
| 🟡 轻微问题 (Minor) | 4 | ✅ 2/4 已修复 |
| 💡 优化建议 (Enhancement) | 15 | 待后续处理 |

---

## 🔴 严重问题 (必须修复) - ✅ 全部已修复

### 1. [P0] `constants.ts` 夜间顺序包含未定义角色 ✅ 已修复

**修复内容**: 移除了 `barman`, `bookworm`, `steward`, `knight`, `shaman`, `pixie`, `noble`, `demon` 等未定义的角色ID。

---

### 2. [P0] `types.ts` 类型安全问题 ✅ 已修复

**修复内容**: 
- 新增 `NightActionPayload` 接口定义具体载荷类型
- `NightActionRequest.payload` 现在使用 `NightActionPayload` 类型而非 `any`

---

### 3. [P0] `types.ts` 已弃用字段说明 ✅ 已修复

**修复内容**: 
- 为 `roleId` 字段添加了 `@deprecated` JSDoc 注释
- 说明迁移路径和计划移除版本 (v0.8.0)

---

## 🟠 中等问题 (建议尽快修复)

### 4. [P1] `NightActionManager.tsx` 酒鬼/疯子检测 ✅ 已确认正确

**状态**: 代码审查确认检测逻辑已正确实现 (`isFakeRole = realRoleId && seenRoleId && realRoleId !== seenRoleId`)，包含非空检查。

---

### 5. [P1] `Controls.tsx` 代码过长 ⏳ 待重构

**状态**: 建议在后续版本中拆分为子组件

---

### 6. [P1] 缺少全局错误边界 ✅ 已修复

**修复内容**:
- 新增 `components/ErrorBoundary.tsx` 组件
- 在 `App.tsx` 中包装应用，捕获所有未处理的错误

---

### 7. [P1] `VotingChart.tsx` 组件 props 问题 ✅ 已修复

**修复内容**: 添加了 `VotingChartProps` 接口，支持通过 props 传入 `voteHistory` 和 `seats`

---

## 🟡 轻微问题 (可择机修复)

### 8. [P2] `PhaseIndicator.tsx` 样式硬编码 ✅ 已修复

**修复内容**: 提取 `CONNECTION_STYLES` 常量对象管理连接状态样式

---

### 9. [P2] z-index 统一管理 ✅ 已修复

**修复内容**: 在 `constants.ts` 中添加 `Z_INDEX` 常量对象统一管理层级

---

### 10. [P2] `Controls.tsx` Tab 状态不持久化 ⏳ 待实现

**建议**: 使用 zustand 或 localStorage 持久化

---

### 11. [P2] 部分角色缺少 `detailedDescription` ⏳ 待补充

**建议**: 为 Trouble Brewing 的所有角色添加完整描述

---

## 💡 优化建议 (提升代码质量)

### 性能优化

| # | 建议 | 文件 | 优先级 |
|---|------|------|--------|
| 1 | Konva Layer 添加 `listening={false}` 优化非交互元素 | `Grimoire.tsx` | 中 |
| 2 | 消息列表使用虚拟滚动 (react-window) | `Chat.tsx` | 低 |
| 3 | 使用 `useMemo` 优化角色列表过滤 | `RoleReferencePanel.tsx` | 低 |
| 4 | 使用 `useCallback` 避免子组件重渲染 | 多个组件 | 低 |

### 架构优化

| # | 建议 | 说明 | 优先级 |
|---|------|------|--------|
| 5 | 引入 `immer` 简化深层状态更新 | store.ts 嵌套状态多 | 中 |
| 6 | 创建通用 hooks 目录 | useLongPress 等可复用 | 中 |
| 7 | 添加 API 层抽象 | Supabase 调用封装 | 低 |
| 8 | 引入 i18n 国际化 | 硬编码中文较多 | 低 |

### 测试与质量

| # | 建议 | 说明 | 优先级 |
|---|------|------|--------|
| 9 | 添加 Jest 单元测试 | 特别是 store 逻辑 | 高 |
| 10 | 添加 React Testing Library | 组件测试 | 中 |
| 11 | 配置 ESLint 更严格规则 | 启用 @typescript-eslint/strict | 中 |
| 12 | 添加 Husky pre-commit 钩子 | 自动检查 | 低 |

### 开发体验

| # | 建议 | 说明 | 优先级 |
|---|------|------|--------|
| 13 | 添加 Storybook | 组件文档和开发 | 低 |
| 14 | 配置 path aliases | `@/components` 替代相对路径 | 低 |
| 15 | 添加 .nvmrc | 锁定 Node 版本 | 低 |

---

## 📋 修复优先级路线图

### 第一阶段 (P0 - 立即) ✅ 已完成
- [x] 清理 `constants.ts` 中未定义的夜间顺序角色
- [x] 为 `NightActionRequest.payload` 定义具体类型
- [x] 决定并统一 `roleId` / `seenRoleId` 使用策略 (添加弃用标记)

### 第二阶段 (P1 - 本周) ✅ 大部分完成
- [x] 确认酒鬼/疯子检测逻辑正确
- [ ] 拆分 `Controls.tsx` 为子组件 (待后续)
- [x] 实现全局 ErrorBoundary
- [x] 修复 VotingChart props 问题

### 第三阶段 (P2 - 本月)
- [x] 统一 z-index 管理
- [x] 提取样式常量
- [ ] 完善角色详细描述
- [ ] 添加基础单元测试

### 第四阶段 (Enhancement - 后续)
- [ ] 性能优化 (虚拟滚动、memo)
- [ ] 架构优化 (hooks、API 层)
- [ ] 开发体验提升 (Storybook、aliases)

---

## ✅ 已确认正常的功能

经审查确认以下核心功能实现正确：

- ✅ Supabase 实时同步机制
- ✅ 双重身份系统 (realRoleId/seenRoleId)
- ✅ 原子入座 RPC 函数
- ✅ 夜间行动交互面板
- ✅ 投票历史记录和可视化
- ✅ AI 多模型集成
- ✅ 移动端长按交互
- ✅ 触觉反馈实现
- ✅ 连接状态指示器
- ✅ 主动技能按钮系统

---

<p align="center">
  <strong>审查完成 ✓</strong><br>
  Generated by Code Review - 2025-11-27
</p>
