# 🔧 Grimoire Web 优化清单

> **审查日期**: 2025-11-28  
> **审查版本**: v0.8.0  
> **审查范围**: 全项目源代码  
> **最后更新**: 2025-11-28 (v0.8.0 Bug 修复)

---

## 📊 审查摘要

| 类别 | 数量 | 状态 |
|------|------|------|
| 🔴 严重问题 (Critical) | 0 | ✅ 全部已修复 |
| 🟠 中等问题 (Medium) | 0 | ✅ 全部已修复 |
| 🟡 轻微问题 (Minor) | 0 | ✅ 全部已修复 |
| 💡 优化建议 (Enhancement) | 17 | 🔄 部分已实现 |

---

## ✨ v0.8.0 Bug 修复

### 崩溃修复
- ✅ AudioManager setTimeout 内存泄漏修复
- ✅ FloatingVoteButton 类型错误修复 (odId→id, isActive→isOpen)
- ✅ ControlsSTSection nightQueue 索引类型修复
- ✅ gameLogic.ts getSetupRules 返回类型修复

### Z-Index 层级修复
- ✅ RoleReferenceSidebar 使用 Z_INDEX.sidebar (40)
- ✅ Grimoire Context Menu 使用 Z_INDEX.modal

### 移动端优化
- ✅ SandboxView 座位响应式大小 (w-14 h-14 md:w-16 md:h-16)
- ✅ 添加触摸反馈 (active:scale-95)

### 代码清理
- ✅ 移除 App.tsx 未使用导入
- ✅ 修复 useEffect 返回值
- ✅ 类型谓词过滤 scriptRoles

---

## ✨ v0.7.5 已实现优化

### 基础设施
- ✅ ESLint 9 + TypeScript 严格模式
- ✅ Vitest 测试框架 (25个单元测试)
- ✅ Husky + lint-staged 预提交检查
- ✅ immer 中间件集成

### 组件拆分
- ✅ ActiveAbilityButton.tsx 提取
- ✅ VoteButton.tsx 提取
- ✅ ControlsGameTab.tsx 提取
- ✅ ControlsAITab.tsx 提取
- ✅ useLongPress hook 提取

### 性能优化
- ✅ Konva 图层分离 (装饰层 vs 交互层)

### 新功能
- ✅ 沙盒模式 (sandboxStore + SandboxView)
- ✅ AudioEnableOverlay 组件
- ✅ VoiceRoomLink 组件

---

## 🔴 严重问题 (必须修复) - ✅ 全部已修复

### 1. [P0] `VotingChart.tsx` 类型错误 ✅ 已修复

**问题描述**: 
- `VoteRecord.votes` 类型定义为 `number[]`，曾被错误地作为对象处理。

**修复验证**: 
- 代码已使用 `.length` 获取票数。
- 代码已使用 `.map()` 遍历投票数组。
- 状态: **已修复**

---

### 2. [P0] `constants.ts` 夜间顺序包含未定义角色 ✅ 已确认正确

**修复内容**: 经验证，`NIGHT_ORDER_FIRST` 和 `NIGHT_ORDER_OTHER` 中的所有角色ID均在 ROLES 中定义。

---

### 3. [P0] `types.ts` 类型安全问题 ✅ 已修复

**修复内容**: 
- `NightActionPayload` 接口已定义。
- `NightActionRequest` 使用了强类型 payload。

---

### 4. [P0] `types.ts` 已弃用字段说明 ✅ 已修复

**修复内容**: 
- `Seat.roleId` 已标记为 `@deprecated`。
- 推荐使用 `seenRoleId`。

---

## 🟠 中等问题 (建议尽快修复)

### 5. [P1] `NightActionManager.tsx` 酒鬼/疯子检测 ✅ 已确认正确

**状态**: 代码审查确认检测逻辑已正确实现。

---

### 6. [P1] `Controls.tsx` 代码过长 ⏳ 待重构

**当前状态**: 文件约 700+ 行  
**建议**: 
- 拆分为 `ControlsGame.tsx`, `ControlsChat.tsx`, `ControlsAI.tsx`, `ControlsNotebook.tsx`
- 提取 `ActiveAbilityButton` 为独立组件
- 使用 React.lazy 进行代码分割

---

### 7. [P1] 缺少全局错误边界 ✅ 已修复

**修复内容**:
- 已存在 `components/ErrorBoundary.tsx` 组件。

---

### 8. [P1] `VotingChart.tsx` 组件 props 问题 ✅ 已修复

**修复内容**: `VotingChart` 已支持 `voteHistory` 和 `seats` props。

---

### 9. [P1] `store.ts` joinSeat 竞态条件风险 ✅ 已修复

**修复验证**: 
- `joinSeat` 使用了 `supabase.rpc('claim_seat')` 进行原子化操作。
- 数据库层面的锁机制避免了客户端竞态条件。
- 之前的模块级锁变量已移除，采用更可靠的 RPC 方案。

---

## 🟡 轻微问题 (可择机修复) - ✅ 全部已修复

### 10. [P2] `PhaseIndicator.tsx` 样式硬编码 ✅ 已修复

**修复内容**: 已提取 `CONNECTION_STYLES` 常量。

---

### 11. [P2] z-index 统一管理 ✅ 已修复

**修复内容**: `constants.ts` 中已包含 `Z_INDEX` 常量。

---

### 12. [P2] `Controls.tsx` Tab 状态不持久化 ✅ 已修复

**修复内容**: 
- 使用 `localStorage` 初始化和保存 `activeTab` 状态。
- 刷新页面后可保持在当前标签页。

---

### 13. [P2] 部分角色缺少 `detailedDescription` ✅ 已确认完整

**修复验证**:
- 经再次核查 `constants.ts`，Trouble Brewing (TB) 剧本的所有角色（如 washerwoman, imp, baron 等）均已包含 `detailedDescription` 字段。
- 之前的标记为误报。

---

## 💡 优化建议 (提升代码质量)

### 性能优化

| # | 建议 | 文件 | 优先级 |
|---|------|------|--------|
| 1 | Konva Layer 添加 `listening={false}` 优化非交互元素 | `Grimoire.tsx` | 中 |
| 2 | 消息列表使用虚拟滚动 (react-window) | `Chat.tsx` | 低 |
| 3 | 使用 `useMemo` 优化角色列表过滤 | `RoleReferencePanel.tsx` | 低 |
| 4 | 使用 `useCallback` 避免子组件重渲染 | 多个组件 | 低 |
| 5 | `AudioManager.tsx` 添加 play promise 取消逻辑 | `AudioManager.tsx` | 中 |

### 架构优化

| # | 建议 | 说明 | 优先级 |
|---|------|------|--------|
| 6 | 引入 `immer` 简化深层状态更新 | store.ts 嵌套状态多 | 中 |
| 7 | 创建通用 hooks 目录 | useLongPress 等可复用 | 中 |
| 8 | 添加 API 层抽象 | Supabase 调用封装 | 低 |
| 9 | 引入 i18n 国际化 | 硬编码中文较多 | 低 |

### 移动端优化

| # | 建议 | 说明 | 优先级 |
|---|------|------|--------|
| 10 | `Grimoire.tsx` 长按与缩放冲突 | ✅ 已修复 (检测多指触摸) | 中 |
| 11 | `Chat.tsx` iOS 键盘处理 | ✅ 已修复 (使用 `visualViewport` API) | 低 |

### 测试与质量

| # | 建议 | 说明 | 优先级 |
|---|------|------|--------|
| 12 | 添加 Jest 单元测试 | 特别是 store 逻辑 | 高 |
| 13 | 添加 React Testing Library | 组件测试 | 中 |
| 14 | 配置 ESLint 更严格规则 | 启用 @typescript-eslint/strict | 中 |
| 15 | 添加 Husky pre-commit 钩子 | 自动检查 | 低 |

### 开发体验

| # | 建议 | 说明 | 优先级 |
|---|------|------|--------|
| 16 | 添加 Storybook | 组件文档和开发 | 低 |
| 17 | 配置 path aliases | `@/components` 替代相对路径 | 低 |
| 18 | 添加 .nvmrc | 锁定 Node 版本 | 低 |

---

<p align="center">
  <strong>审查完成 ✓</strong><br>
  Generated by Code Review - v0.7.6 - 2025-11-27
</p>
