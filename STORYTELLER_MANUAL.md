## 📑 目录

1. [快速开始](#-快速开始)
2. [游戏准备](#-游戏准备)
3. [核心功能详解](#-核心功能详解)
4. [高级功能](#-高级功能)
5. [v0.7.0 新功能](#-v070-新功能)
6. [最佳实践](#-最佳实践)
7. [常见问题](#-常见问题)

---

## 🚀 快速开始

### 30秒开局流程

1. **创建房间**
   - 进入首页，输入您的名字
   - 勾选 "我是说书人"
   - 点击 "创建游戏"
   - 记下房间号（4位数字）

2. **配置游戏**
   - 选择剧本（默认Trouble Brewing）
   - 设置玩家数量（推荐7-15人）
   - 决定是否允许悄悄话（`allowWhispers`）

3. **等待玩家加入**
   - 将房间号告知玩家
   - 玩家通过"加入房间"输入房间号连接
   - 在魔典中看到玩家昵称后，拖拽分配座位

4. **开始游戏**
   - 点击 "☀ 白天" 开始第一个白天
   - 或直接点击 "🌙 夜间" 进入首夜

---

## 🎮 游戏准备

### 1. 剧本选择

#### 内置剧本
- **Trouble Brewing** (TB): 基础入门剧本，平衡性好
- **Bad Moon Rising** (BMR): 进阶剧本（全角色已添加详细描述）
- **Sects & Violets** (S&V): 高级剧本（全角色已添加详细描述）

#### 导入自定义剧本
1. 点击 Controls → **剧本** tab
2. 点击 "📥 导入剧本"
3. 上传 JSON 文件（格式见 [README](./README.md#剧本导入指南)）
4. 剧本导入后会出现在下拉菜单中

### 2. 角色分配

#### 方式一：自动分配（建议）
1. 在 Grimoire 面板顶部点击 "🎲 随机分配角色"
2. 系统会根据玩家数量自动配置符合规则的角色组合
3. 检查每个座位的角色是否合理

#### 方式二：手动分配
1. 点击任意座位（桌面端右键，**移动端长按**）
2. 在弹出菜单中选择角色
3. 角色图标会显示在座位上
4. 再次点击座位可修改角色或添加提醒标记

### 3. 状态标记

每个座位支持以下标记：

| 图标 | 状态 | 说明 |
|------|------|------|
| ☠️ | **死亡** | 玩家已死亡 |
| 🍷 | **喝醉** | 能力失效，获得错误信息 |
| 💀 | **中毒** | 能力失效（玩家不知道） |
| 👻 | **幽灵票** | 死亡玩家有一次投票机会 |
| 📝 | **自定义提醒** | 例如"已查验"、"保护中" |

**操作**: 点击座位 → 勾选对应状态复选框

---

## 🔐 v0.7.0 新功能

### 1. 双重身份系统

**问题背景**: 
某些角色（如酒鬼、疯子、魔偶）玩家看到的身份与真实身份不同。

**解决方案**:
- **realRoleId**: 真实身份，仅说书人可见，用于能力判定
- **seenRoleId**: 展示身份，玩家看到的角色
- 客户端会自动根据用户身份过滤，玩家只看到 `seenRoleId`

**使用方式**:
1. 分配酒鬼时选择 "Drunk"，系统自动处理
2. 玩家会看到一个假的镇民角色
3. 说书人在魔典上看到真实身份标记

### 2. 连接状态指示器

**功能**: 实时显示网络连接状态

**状态说明**:
| 状态 | 颜色 | 说明 |
|------|------|------|
| connecting | 灰色+脉冲 | 正在连接中 |
| connected | 绿色 | 连接正常 |
| reconnecting | 黄色+脉冲 | 正在重连 |
| disconnected | 红色 | 已断开连接 |

**显示位置**: PhaseIndicator 顶部Banner右侧

### 3. 移动端长按交互

**问题背景**: 
移动设备无法右键点击，说书人难以操作座位菜单。

**解决方案**:
- 长按座位 500ms 触发上下文菜单
- 触发时产生触觉反馈（vibrate）
- 与桌面端右键菜单功能完全一致

**操作流程**:
1. 确保魔典未锁定（点击右上角 🔓 解锁）
2. 长按任意座位约0.5秒
3. 手机振动后释放
4. 弹出角色/状态选择菜单

### 4. 详细角色描述

**覆盖范围**:
- Bad Moon Rising: 全部25个角色
- Sects & Violets: 全部25个角色
- 包含官方完整规则说明 + 中文翻译

**查看方式**:
1. 在Controls右上角切换 "详细" 模式
2. 点击角色卡查看完整描述
3. 或在规则手册中查阅

### 5. 主动技能按钮

**支持角色**:
| 角色 | 技能 | 使用方式 |
|------|------|----------|
| 杀手 (Slayer) | 🏹 选择目标发动 | 白天，输入目标名称 |
| 处女 (Virgin) | 🕯️ 声明身份 | 白天，无需目标 |
| 艺术家 (Artist) | 🎨 向ST提问 | 白天，无需目标 |
| 杂耍艺人 (Juggler) | 🤹 猜测角色 | 白天，输入猜测内容 |
| 造谣者 (Gossip) | 💬 发表陈述 | 白天，无需目标 |

**操作流程**:
1. 玩家在角色卡区域看到技能按钮
2. 点击按钮
3. 如需目标，输入目标信息
4. 系统自动在聊天中公告技能使用
5. 按钮变灰，显示"技能已使用"

### 6. 原子入座机制

**问题背景**: 
多人同时抢座可能导致数据冲突。

**解决方案**:
- 使用 Supabase RPC 函数 `claim_seat()`
- 数据库级别锁定确保原子性
- 座位被占时返回错误信息

---

## 🎯 核心功能详解

### Phase 1: 白天阶段 (Day)

#### 1.1 聊天管理

**公开聊天**
- 玩家默认可以公开发言
- 所有人可见
- 用于讨论、辩论、信息交换

**私密聊天 (悄悄话)**
- 需要启用 `allowWhispers`
- 玩家可选择接收人发送私信
- 仅发送人、接收人和说书人可见
- 消息显示为紫色边框

**说书人专属功能**
- **AI 咨询**: 在 AI Tab 输入规则问题，获得智能建议
  - 支持 6+ 模型切换（DeepSeek R1、MiniMax M2、Kimi K2等）
  - AI 回复仅您可见（紫色私密消息）
- **清空消息**: 点击聊天区域右上角 "🗑️ 清空" 删除所有消息
- **删除单条**: 鼠标悬停在消息上，点击 "×" 删除

#### 1.2 提名与投票

**流程**:
1. 玩家点击 "🖐 举手" 申请发言
2. 说书人点击 "开始投票" → 选择提名人和被提名人
3. 系统进入投票阶段，所有玩家看到投票 UI
4. 玩家点击 "✋ 投票" 或 "👎 弃权"
5. 说书人在 "当前投票" 区域看到实时票数
6. 点击 "结束投票" → 系统自动判断结果：
   - **票数 > 存活玩家数/2**: 被提名人处决
   - **票数 ≤ 存活玩家数/2**: 被提名人存活
7. 投票数据自动记录到投票历史

**投票历史查看**:
- 游戏结束后，点击 "📜 历史记录" → "Voting History" tab
- 查看折线图和详细表格，分析投票趋势

### Phase 2: 夜间阶段 (Night)

#### 2.1 夜间顺序 (Night Order)

**Night Order 显示**:
- 在 Controls → Night tab 中查看
- 显示当前应执行动作的角色
- 使用 "<" 和 ">" 按钮切换角色

#### 2.2 智能夜间助手 ⭐ NEW

这是 v0.3.0 的核心功能，大幅提升夜间操作效率！

**使用流程**:
1. 切换到夜间阶段 (`🌙 Night`)
2. 在 Night Order 找到当前角色
3. 点击 "🌙 执行夜间动作" 按钮
4. 弹出交互式面板，根据提示操作：

**交互类型**:

| 类型 | 角色示例 | 操作说明 |
|------|----------|----------|
| **单选玩家** | 小恶魔、僧侣 | 从下拉菜单选择1名玩家，点击"确认" |
| **双选玩家** | 占卜师、洗衣妇 | 选择2名玩家，点击"确认" |
| **二选一** | 守鸦人 | 从两个选项中选择一个（如"新角色"或"保持原样"） |
| **确认** | 初夜信息 | 仅需确认已告知玩家信息 |

**自动日志**:
- 操作完成后，系统会自动在聊天记录中生成日志
- 例如: `"说书人执行了【小恶魔】的夜间能力（目标：座位3）"`
- 方便回溯和记录

**已配置角色**:
- ✅ 占卜师 (Fortune Teller) - 双选玩家查验
- ✅ 僧侣 (Monk) - 单选玩家保护
- ✅ 守鸦人 (Ravenkeeper) - 单选玩家查验（死亡时）
- ✅ 投毒者 (Poisoner) - 单选玩家中毒
- ✅ 小恶魔 (Imp) - 单选玩家杀死

**扩展自定义角色**:
在 `constants.ts` 中为角色添加 `nightAction` 字段：
```typescript
{
  id: 'investigator',
  name: '调查员',
  nightAction: {
    type: 'choose_player',
    prompt: '选择要查验的玩家'
  }
}
```

#### 2.3 手动告知信息

对于未配置夜间助手的角色，手动操作：
1. 使用私聊功能单独告知玩家信息
2. 或使用 **结构化信息卡片**（见下文）

### Phase 3: 投票阶段 (Voting)

系统会自动处理投票逻辑，您只需：
1. 点击 "开始投票" 选择提名人和被提名人
2. 等待玩家投票
3. 点击 "结束投票" 宣布结果

**特殊场景**:
- 如需取消投票: 点击 "取消投票"
- 死亡玩家投票: 勾选玩家的 "幽灵票" 状态

---

## 🎭 Phase 5: 游戏流程优化 (v0.4.0 新功能)

### 5.1 阶段指示器

**实时阶段提示**:
- 界面顶部显示Banner，实时展示当前游戏阶段
- 说书人和玩家都能看到，但提示内容不同

**阶段说明**:

| 阶段 | 说书人显示 | 玩家显示 | 说明 |
|------|-----------|---------|------|
| ASSIGNING | 🎭 正在分配角色... | ⏳ 等待说书人分配角色... | 初始状态 |
| READY | ✅ 角色已发放，准备开始游戏 | ✅ 角色已发放，可查看规则手册 | 发放后 |
| NIGHT | 🌙 夜间阶段 | 🌙 夜间阶段 | 游戏中 |
| DAY | ☀️ 白天阶段 | ☀️ 白天阶段 | 游戏中 |
| VOTING | 📊 投票中：座位X | 📊 投票中：座位X | 游戏中 |
| END | 🎉 好人胜利！/ 💀 邪恶胜利！ | 🎉 好人胜利！/ 💀 邪恶胜利！ | 结束 |

### 5.2 智能角色分配

**一键自动分配** ⭐ NEW:
1. 在Controls → Setup tab找到"游戏设置"面板
2. 点击 "🎲 自动分配角色"
3. 系统根据当前在线玩家数自动配置角色组成（基于TB官方规则）
4. 系统消息显示分配结果，例如：
   ```
   已自动分配角色 (7人: 5镇民+0外来者+1爪牙+1恶魔)
   ```

**支持人数**: 5-15人
**配置规则**:
- 5人: 3镇民 + 0外来者 + 1爪牙 + 1恶魔
- 7人: 5镇民 + 0外来者 + 1爪牙 + 1恶魔（经典配置）
- 10人: 7镇民 + 0外来者 + 2爪牙 + 1恶魔
- 15人: 9镇民 + 2外来者 + 3爪牙 + 1恶魔

**优势**:
- 节省时间，无需手动计算和分配
- 确保符合官方规则
- 随机打乱角色顺序，避免规律性

### 5.3 角色发放机制

**新的三阶段流程**:

#### 阶段1: ASSIGNING（分配中）
- 说书人分配或调整角色
- 玩家**不可见**角色信息
- 可随时修改角色配置
- 📖规则手册按钮禁用

#### 阶段2: READY（已发放）
- 点击 "✅ 发放角色" 进入
- 玩家**可查看**规则手册（包括自己的角色高亮）
- 说书人仍可点击 "🔙 收回角色" 返回ASSIGNING
- 出现 "🎮 开始游戏" 按钮（带脉冲动画）

#### 阶段3: STARTED（游戏中）
- 点击 "🎮 开始游戏" 进入
- 自动切换到首夜阶段
- 游戏正式开始
- 无法再调整角色

**操作流程**:
```
1. 自动分配/手动分配角色
   ↓
2. 点击"发放角色"（玩家可查看规则手册）
   ↓
3. 确认无误后，点击"开始游戏"
   ↓
4. 进入首夜，按夜间顺序执行能力
```

**收回功能**:
- 如发现角色配置错误，在READY阶段点击 "🔙 收回角色"
- 返回ASSIGNING，玩家规则手册再次禁用
- 重新调整后再次发放

### 5.4 快速开局流程（v0.4.0优化版）

**3步开局** (相比旧版省略多步操作):

1. **创建+分配** (30秒)
   - 创建房间，等玩家就位
   - 点击 "🎲 自动分配角色"

2. **发放** (5秒)
   - 点击 "✅ 发放角色"
   - 玩家可自行查看规则手册

3. **开始** (5秒)
   - 点击 "🎮 开始游戏"
   - 自动进入首夜

**总计**: 不到1分钟即可开局！

### 5.5 📊 板子参考系统 (v0.6.0 新功能) ⭐ NEW

**功能简介**:
- 基于当前玩家人数提供科学的角色配置建议
- 4种配置策略，适应不同难度和游戏风格
- 角色强度分级参考，帮助新手说书人快速上手

**使用流程**:
1. 在Controls → Setup tab找到"游戏设置"面板
2. 点击 "📊 板子参考" 按钮
3. 查看当前玩家人数的标准配比
4. 选择适合的策略查看详细建议

**四种配置策略**:

####

## 🚀 高级功能

### 1. 结构化信息卡片 ⭐ NEW

代替纯文本消息，发送格式化的信息卡片！

**使用场景**:
- 告知玩家查验结果
- 发送角色能力提醒
- 公布重要游戏事件

**如何发送**:
目前需要通过代码调用（未来版本会添加 UI）：
```typescript
import { useStore } from './store';

const sendInfoCard = useStore(state => state.sendInfoCard);

// 示例1: 发送查验结果给玩家
sendInfoCard({
  type: 'role_info',
  title: '占卜师查验结果',
  icon: '🔮',
  color: 'blue',
  content: '你获知：座位3和座位7中，有一位是【图书管理员】。'
}, playerId); // playerId = 'user_xxx'

// 示例2: 全体公告
sendInfoCard({
  type: 'hint',
  title: '重要提示',
  icon: '⚠️',
  content: '今晚有玩家使用了特殊能力，请注意观察。'
}, null); // null = 发送给所有人
```

**卡片类型**:
| 类型 | 颜色 | 适用场景 |
|------|------|----------|
| `role_info` | 蓝色 | 角色查验、身份信息 |
| `ability` | 紫色 | 能力使用提示、技能说明 |
| `hint` | 琥珀色 | 游戏提示、规则说明 |
| `custom` | 灰色 | 自定义任意内容 |

### 2. AI 规则助手

**模型选择**:
在 Controls → AI tab 下拉菜单切换模型：

**DeepSeek R1 系列** (推理优化):
- 🧠 DeepSeek R1 (Full) - 最强推理能力
- 🦙 R1 Llama 70B - 平衡性能
- 🤖 R1 Qwen 32B - 中等速度
- ⚡ R1 Qwen 7B Pro - 最快响应

**其他高性能**:
- 🦄 MiniMax M2 (230B) - 大规模参数
- 🤔 Kimi K2 Thinking - 思维链推理

**使用技巧**:
- 直接问规则: `"如果占卜师查验了喝醉的玩家会怎样？"`
- 要求生成台词: `"帮我生成恶魔阵营的开局台词"`
- 复杂判例: `"守鸦人被小恶魔杀死，同时僧侣保护了守鸦人，应该如何处理？"`

**思维过程查看**:
- DeepSeek R1 会显示 `<think>` 标签包裹的推理过程
- 点击展开/折叠查看 AI 的思考路径

### 3. 音效管理

**自动播放**:
- 切换阶段时自动播放对应音效
- 在 Controls → Audio tab 调节音量
- 支持音轨: 白天、夜晚、投票、游戏结束

**手动控制**:
- 点击 "▶" 播放当前音效
- 点击 "⏸" 暂停
- 拖动音量条调节音量（0-100%）

### 4. 游戏历史记录

**自动保存**:
- 游戏结束时，点击 "游戏结束" → 选择获胜阵营
- 系统自动保存完整数据到 Supabase `game_history` 表

**查看历史**:
- 点击 Controls → "📜 历史记录"
- 左侧列表显示最近 20 局游戏
- 点击任意记录查看:
  - **Details Tab**: 玩家列表、角色配置、聊天记录
  - **Voting History Tab**: 投票趋势图和详细数据 ⭐ NEW

---

## 💡 最佳实践

### 游戏前准备

1. **提前测试环境**
   - 确保 Supabase 连接正常
   - 测试 AI 模型是否可用
   - 检查音效播放是否正常

2. **准备剧本资料**
   - 熟悉剧本中所有角色的能力和夜间顺序
   - 打印或在另一台设备上打开官方角色手册
   - 如使用自定义剧本，提前导入并测试

3. **玩家沟通**
   - 提前告知玩家房间号获取方式
   - 说明悄悄话规则（是否允许、如何使用）
   - 提醒玩家保持网络连接稳定

### 游戏中技巧

1. **夜间操作**
   - 使用智能夜间助手加速流程
   - 对复杂能力（如炼金术师、间谍），手动私聊确保准确
   - 记得在夜间日志中简要记录关键信息

2. **信息管理**
   - 重要查验结果使用**结构化信息卡片**发送，更清晰
   - 白天讨论时适当清空无关消息，保持聊天区整洁
   - AI 咨询时要具体，避免过于宽泛的问题

3. **投票引导**
   - 提醒玩家举手后需等待说书人开启投票
   - 控制投票节奏，避免过快或过慢
   - 使用投票历史分析可疑行为（游戏后复盘）

### 常见陷阱

❌ **不要**在夜间随意点击角色
  - 夜间助手会记录操作，误操作会生成日志

❌ **不要**忘记更新状态标记
  - 死亡、中毒、喝醉等状态影响能力判定

❌ **不要**依赖 AI 做最终裁决
  - AI 仅作参考，最终判断权在说书人

✅ **务必**在游戏结束前保存历史
  - 点击"游戏结束"按钮，否则数据丢失

---

## 🛠️ 常见问题

### Q1: 玩家断线怎么办？
**A**: 
- 玩家刷新页面后重新输入房间号即可恢复连接
- 座位信息和魔典状态会自动同步
- 建议在关键时刻提醒玩家不要刷新

### Q2: 如何撤销角色分配？
**A**:
- 点击座位 → 选择 "无角色"
- 或直接分配新角色覆盖

### Q3: AI 响应很慢或报错？
**A**:
- 检查 `.env.local` 中对应的 API Key 是否有效
- 尝试切换其他模型（如从 DeepSeek 切换到 Kimi）
- 检查网络连接，某些模型在国内可能需要代理

### Q4: 夜间助手没有我要的角色？
**A**:
- 当前仅配置了部分常用角色
- 您可以在 `constants.ts` 中为任何角色添加 `nightAction` 字段
- 或手动使用私聊/信息卡片告知玩家

### Q5: 投票历史图表不显示？
**A**:
- 确保已执行 `npm install recharts`
- 检查浏览器控制台是否有报错
- 投票历史仅在有投票记录时才显示数据

### Q6: 如何备份游戏数据？
**A**:
- 游戏数据存储在 Supabase，建议定期导出 `game_history` 表
- 可以在 Supabase Dashboard 中手动导出 CSV
- 本地环境变量文件 `.env.local` 也应备份

---

## 📞 技术支持

### 遇到 Bug？
1. 查看浏览器控制台 (F12) 错误信息
2. 检查 Supabase 连接状态
3. 在 GitHub 提交 Issue 并附上:
   - 错误截图
   - 控制台日志
   - 复现步骤

### 功能建议？
欢迎在 GitHub Issues 提出您的想法！

---

## 🎓 延伸阅读

- [魔典使用指南](./USER_GUIDE.md) - 玩家视角的操作说明
- [Blood on the Clocktower 官方 Wiki](https://wiki.bloodontheclocktower.com/)
- [剧本设计指南](https://www.reddit.com/r/BloodOnTheClocktower/)

---

<p align="center">
  <strong>祝您主持愉快！🎭</strong><br>
  Have a bloody good game!
</p>
